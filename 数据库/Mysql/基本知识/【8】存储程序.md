![[Pasted image 20230906170544.png]]
## 前置知识


### 自定义变量


```sql
-- 设置变量
SET @a = 1;

-- 使用
SELECT @1;

-- 设置为字符串
SET @a = 'test';

-- 将值赋值给另一个变量
SET @b = @a;

-- 将查询结构赋值给变量
SET @a = (SELECT m1 FROM t1 LIMIT 1);

-- 另一种方式赋值
SELECT n1 FROM t1 LIMIT 1 INTO @b;

-- 同时给两个变量赋值
SELECT m1, n1 FROM t1 LIMIT 1 INTO @a, @b;
```

### 语句结束分隔符

> 默认的结束分隔符有 `;` `\g` `\G`

可以使用以下语句重新替换掉`;`

`delimiter 结束符号名`

```shell
mysql> delimiter $
# 改了以$为结束符后, ;不会结束，所以下面一下输出三条结果
mysql> SELECT * FROM t1 LIMIT 1;
    -> SELECT * FROM t2 LIMIT 1;
    -> SELECT * FROM t3 LIMIT 1;
    -> $
+------+------+
| m1   | n1   |
+------+------+
|    1 | a    |
+------+------+
1 row in set (0.00 sec)

+------+------+
| m2   | n2   |
+------+------+
|    2 | b    |
+------+------+
1 row in set (0.00 sec)

+------+------+
| m3   | n3   |
+------+------+
|    3 | c    |
+------+------+
1 row in set (0.00 sec)

mysql>
```

注意: 不要使用反斜杠(\)字符作为语句结束分隔符，这是MySQL的转义字符

## 存储函数

### 创建存储函数

```sql
CREATE FUNCTION 函数名([参数列表]) 
RETURN 返回值类型
BEGIN
	函数体内容
END
```

注意: mysql的默认配置是不允许创建函数的，需要设置
`SET GLOBAL log_bin_trust_function_creators = 1;`

```shell
## 创建一个根据专业获取这个专业的平均分

## 因为函数要用到;所以要将结束符暂时设置为$
mysql> delimiter $
mysql> CREATE FUNCTION avg_score_by_subject(s VARCHAR(100))
	-> RETURNS DOUBLE
	-> BEGIN
	->	RETURN (SELECT AVG(score) FROM student_score WHERE subject = s);
	-> END $
Query OK, 0 rows affected (0.00 sec)
## 恢复结束符为;
mysql: delimiter ;

## 使用存储函数
mysql> SELECT avg_score_by_subject('地理');
+------------------------------------+ 
| avg_score('地理') | 
+------------------------------------+ 
| 73 | 
+------------------------------------+ 
1 row in set (0.00 sec)
```

### 查看/删除存储函数

查看定义了多少存储函数
`SHOW FUNCTION STATUS `


查看具体哪个函数的结构
`SHOW CREATE FUNCTION 函数名`


删除某个函数
`DROP FUNCTION 函数名`

